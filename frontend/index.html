<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CUG 未来城校区猫咪喂食记录</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
        }
        table {
            width: 100%;
            border-collapse: collapse;
        }
        th, td {
            border: 1px solid #ddd;
            padding: 8px;
            text-align: left;
        }
        th {
            background-color: #f2f2f2;
        }
        button {
            cursor: pointer;
        }
    </style>
</head>
<body>
    <h1>未来城校区猫咪喂食记录</h1>
    
    <h2>使用说明</h2>
    <p>这个网站旨在记录未来城校区猫咪的喂食情况，帮助避免猫咪被过度投喂 🐾。你可以通过下方的"测试用"按钮进行喂食功能的测试 🐱🍲。</p>
    <p>如果你今天已经喂过某只猫咪，请在网站上找到相应的猫咪并点击"投喂"按钮 🐾。这样其他人就可以看到这只猫咪今天被喂了多少次，从而决定是否继续喂食或陪伴它 🐾💬。</p>
    <p>本网站的猫咪编号来自于<a href="https://docs.qq.com/sheet/DWXVLaUVPb1ZNdmlr?tab=fliaid">这个表格</a>，里面附有猫咪的照片 📸。</p>

    <p>为了防止误操作导致猫咪被反复投喂 🐾，网站会根据访问者的 IP 地址来判断是否为独立的喂食行为。你的 IP 只用于此目的，不会被用作其他用途 🔒。如果你使用的是 CUG 的校园 Wi-Fi 📶，可能会提示你已经喂过猫咪。此时建议切换到手机流量后再试 📱。</p>
    <p>🪧 欢迎加入 QQ 群：468204487 和大家一起交流。🎉</p>
        
    <p id="userIp">您的IP地址：加载中...</p>
    
    <h2>今日喂食情况</h2>
    <div id="catTable"></div>
    
    <h2>其他信息</h2>
    <p>如果需要补充猫咪的信息，你可以联系微信：cugcats</p>
    <p>最后一列的数据 HAC 代表 historical attention counts，历史上的被关注次数，这个「历史」目前暂时不包括今天， </p>
    <p>由于这个网站还在不断完善，所以不排除未来会不定时的无法访问，或者数据丢失，不用担心，它未来会越来越稳定的。</p>
    <p>项目已开源，点击<a href="https://github.com/CugCats/cugcats">这里</a>查看</p>

    <h2>没有猫粮？</h2>
    <p>果你愿意花些时间照顾一下学校里的猫，可以去猫基地拿小袋装的猫粮，我会尽可能及时补充，如果没了，也可以提醒我补充一下。</p>
    <p>就我个人来说，我非常不希望你花去买猫粮，因为你可能还没有收入来源。如果你还是想花钱，去买《被讨厌的勇气》和《非暴力沟通（华夏出版社版本）》，看十遍，就好了。</p>

    <h2>利益声明</h2>
    <p>本人不会在这个网站上获取任何经济收益，反而会付出比较多的成本，比如猫粮，比如每个月的捐款，因为我有收入可以覆盖这部分成本，所以我不用获利，我在乎的是能做一件有意义的事情，并且，我有了一个作品。</p>
    <p>你（在校内）的传播，是对我最大的支持。</p>

    <script>
        const API_URL = '';

        // 添加这个函数来获取用户IP
        async function getUserIp() {
            try {
                const response = await fetch(`${API_URL}/user-ip`);
                const data = await response.json();
                document.getElementById('userIp').textContent = `您的IP地址：${data.ip}`;
            } catch (error) {
                console.error('Error fetching IP:', error);
                document.getElementById('userIp').textContent = '无法获取IP地址';
            }
        }

        async function getCats() {
            try {
                const response = await fetch(`${API_URL}/cats`);
                const data = await response.json();
                console.log('Fetched cats:', data);
                return data;
            } catch (error) {
                console.error('Error fetching cats:', error);
                return [];
            }
        }

        async function feedCat(catId) {
            await fetch(`${API_URL}/feed/${catId}`, { method: 'POST' });
        }

        const catTable = document.getElementById("catTable");

        function sortAreas(a, b) {
            return a.area_weight - b.area_weight;
        }

        async function updateTable() {
            const cats = await getCats();
            
            // 按区域分组
            const catsByArea = cats.reduce((acc, cat) => {
                if (!acc[cat.area_name]) {
                    acc[cat.area_name] = { cats: [], weight: cat.area_weight };
                }
                acc[cat.area_name].cats.push(cat);
                return acc;
            }, {});

            // 清除现有的表格内容
            catTable.innerHTML = '';

            // 对区域进行排序
            const sortedAreas = Object.entries(catsByArea)
                .sort((a, b) => a[1].weight - b[1].weight)
                .map(([areaName, areaData]) => ({ name: areaName, cats: areaData.cats }));

            // 为每个区域创建一个表格
            for (const area of sortedAreas) {
                const areaHeader = document.createElement('h3');
                areaHeader.textContent = area.name;
                catTable.appendChild(areaHeader);

                const table = document.createElement('table');
                table.innerHTML = `
                    <tr>
                        <th>名字</th>
                        <th>具体位置</th>
                        <th>投喂次数</th>
                        <th>陪伴次数</th>
                        <th>投喂？</th>
                        <th>陪伴？</th>
                        <th>云撸猫</th>
                        <th>想它？</th>
                        <th>编号</th>
                        <th>HAC</th>
                    </tr>
                `;

                const historicalAttentionCounts = await getHistoricalAttentionCounts();

                area.cats.sort((a, b) => {
                    const aCount = historicalAttentionCounts[a.cat_id] || 0;
                    const bCount = historicalAttentionCounts[b.cat_id] || 0;
                    return bCount - aCount;
                });

                area.cats.forEach(cat => {
                    const row = table.insertRow();
                    row.insertCell(0).textContent = cat.name;
                    row.insertCell(1).textContent = cat.specific_location;
                    row.insertCell(2).textContent = cat.count;
                    row.insertCell(3).textContent = cat.companion_count;
                    const feedButton = document.createElement("button");
                    feedButton.textContent = "投喂";
                    feedButton.onclick = () => toggleFed(cat.cat_id);
                    row.insertCell(4).appendChild(feedButton);
                    const companionButton = document.createElement("button");
                    companionButton.textContent = "陪伴";
                    companionButton.onclick = () => toggleCompanion(cat.cat_id);
                    row.insertCell(5).appendChild(companionButton);
                    row.insertCell(6).textContent = cat.miss_count;
                    const missButton = document.createElement("button");
                    missButton.textContent = "想它";
                    missButton.onclick = () => toggleMiss(cat.cat_id);
                    row.insertCell(7).appendChild(missButton);
                    row.insertCell(8).textContent = cat.cat_id;
                    row.insertCell(9).textContent = historicalAttentionCounts[cat.cat_id] || 0;
                });

                catTable.appendChild(table);
            }
        }

        const feedMessages = [
            "小猫咪吃得饱饱的了，真是多亏了你的爱心！🐱❤️",
            "谢谢你喂猫，它一定感受到了你的关怀！🙏🐾",
            "猫咪幸福地吃着食物，它会记住你的善良。😻🍽️",
            "你的一份心意，让猫咪今天多了一份美味！🥰🐈",
            "猫咪已经开心地享用了你的美食，感谢你！🍲😊",
            "感谢你的投喂，小猫咪现在心满意足了！😺💖",
            "你的一点点关爱，猫咪收到了，它很开心！🐾🥳",
            "今天的猫咪特别幸福，谢谢你的喂食！🎉🐱",
            "你喂的猫咪吃得非常开心，感谢你对它的关照。🍖🥰",
            "猫咪肚子圆滚滚的，它特别感激你的投喂！🐈🍗",
            "谢谢你让猫咪今天吃到了好吃的，它一定很开心。😻🍲",
            "你让猫咪的世界又温暖了一些，谢谢你！🌞🐾",
            "猫咪已经满足地吃饱了，它感激你。😺🙏",
            "你的一份投喂让猫咪多了一份欢快，感谢你！🎈🐾",
            "感谢你的一份食物，猫咪吃得心满意足。🍽️😺",
            "猫咪吃得津津有味，它一定非常喜欢你的投喂。🐱🍖",
            "谢谢你，让猫咪今天也吃得很好。😊🐾",
            "猫咪感受到了你的关爱，今天特别满足。❤️🐈",
            "猫咪吃得好开心，谢谢你的关心！🎉😻",
            "你让猫咪的肚子暖暖的，它一定很感激你！🐾🍲",
            "猫咪在享用你送的美味，它会记住你的好。🐱😇",
            "感谢你为猫咪准备的食物，它现在正在幸福地吃着呢！🍽️😺",
            "你的一份投喂让猫咪更加健康快乐，谢谢！🐾🍗",
            "猫咪已经吃饱了，感谢你对它的爱心投喂！😻🙏",
            "谢谢你让猫咪拥有了一顿丰盛的晚餐！🍽️😊",
            "你的一份小小食物，让猫咪的世界更温暖了！🐾❤️",
            "猫咪非常享受你的投喂，感谢你对它的帮助！🍲😺",
            "你让猫咪今天吃得特别满足，谢谢！🎉🐈",
            "小猫咪已经吃饱了，它现在肯定很开心，感谢你！😊🍖",
            "猫咪已经吃得心满意足，它会偷偷感激你哦！🐾😻"
        ];

        const companionMessages = [
            "猫咪感受到了你的陪伴，今天一定很开心！🐱💖",
            "谢谢你抽时间陪伴猫咪，它一定非常满足。🐾😊",
            "小猫咪得到了你的陪伴，它感受到了温暖。😻🌞",
            "感谢你给猫咪带来的陪伴，它会记住你的好。🐱💝",
            "你的陪伴让猫咪今天更安心了，谢谢你。🐾🙏",
            "猫咪陪在你身边，它一定感到非常幸福。🐈🥰",
            "你的一份陪伴让猫咪的世界更加温暖，感谢你！🐾❤️",
            "谢谢你抽空陪猫咪，它一定感受到了你的关爱。🐱🙏",
            "猫咪今天因为你的陪伴变得更开心了，谢谢！🐾😺",
            "你的陪伴让猫咪不再孤单，真是太感谢了！🐱🌟",
            "小猫咪今天得到了你的陪伴，它一定很快乐。😻💖",
            "谢谢你温暖的陪伴，猫咪今天感受到了满满的爱。🐾😊",
            "猫咪今天有了你的陪伴，它心里暖暖的。🐈❤️",
            "感谢你花时间陪伴猫咪，它今天特别满足。🐱🙏",
            "你让猫咪今天不再孤单，它一定感激你！🐾🎉",
            "谢谢你的陪伴，猫咪今天特别开心。🐱😊",
            "猫咪的生活因为你的陪伴变得更加美好，感谢你！🐾💖",
            "你的陪伴让猫咪感受到了温暖，它今天很满足。😻🌟",
            "小猫咪有了你在身边，一定感到非常幸福，谢谢你！🐈😊",
            "猫咪今天和你度过了愉快的时光，它一定很开心。🐱🎉",
            "你让猫咪的日子不再孤独，真是太感谢了！🐾❤️",
        ];

        const missMessages = [
            "猫咪已经感受到你的思念，它的耳朵动了动，好像在回应你呢！🐱💓",
            "小猫咪收到了你的思念，它打了个哈欠，闭上眼睛感受着你的爱。😻💭",
            "你的思念像一阵暖风，轻轻抚过猫咪，它一定感受到了你深深的挂念。🍃🐾",
            "猫咪偷偷告诉我，它感受到了你的思念，心里暖暖的。🐱💖",
            "远方的思念悄悄飘到了猫咪身边，它已经舒服地卷起尾巴了呢！😽💫",
            "猫咪懒洋洋地躺着，好像在等你的思念飞到它身边。🐾🌙",
            "你的思念让猫咪忍不住眯起了眼睛，它知道你一直惦记着它。😻💞",
            "猫咪收到了你的思念，轻轻打了个呼噜，表示它感受到了这份温暖。🐱💌",
            "你的思念像阳光一样洒在猫咪身上，它的心里也充满了暖意。🌞🐾",
            "猫咪感受到了你的思念，它的眼睛闪闪发亮，仿佛在等待与你的重逢。😺✨",
            "你悄悄的思念穿过空气来到猫咪身边，它的耳朵动了动，心里充满了欢喜。🐾💖",
            "猫咪已经感觉到你的思念，尾巴轻轻摆动着，像是在回应你。🐱💫",
            "你默默的思念，像轻轻的抚摸，让猫咪安心地躺下休息。💭😽",
            "猫咪的心里充满了你的思念，它偷偷露出了一个小小的微笑。😻💖",
            "你的思念已经到达，猫咪悄悄转过身，仿佛在偷偷感受你的关怀。🐱💭",
            "猫咪闻到了你思念的气息，缓缓伸了个懒腰，它感到无比满足。🐾🌸",
            "你温柔的思念像是猫咪最喜欢的玩具，让它愉快地轻轻摇摆尾巴。🐱🎾",
            "猫咪收到了你的思念，它甜甜地打了个呼噜，表示它很开心。😺💞",
            "你让猫咪今天和你度过了愉快的时光，它一定很开心。🐱🎉",
            "你让猫咪的日子不再孤独，真是太感谢了！🐾❤️",
        ];

        function showRandomMessage(messages) {
            const randomIndex = Math.floor(Math.random() * messages.length);
            alert(messages[randomIndex]);
        }

        async function toggleFed(catId) {
            const response = await fetch(`${API_URL}/feed/${catId}`, { method: 'POST' });
            const result = await response.json();
            if (result.success) {
                if (result.firstTime) {
                    showRandomMessage(feedMessages);
                }
                await updateTable();
            } else {
                alert('猫咪今天已经吃得很饱了哦，感谢你的关心！🐱🍽️');
            }
        }

        async function toggleCompanion(catId) {
            const response = await fetch(`${API_URL}/companion/${catId}`, { method: 'POST' });
            const result = await response.json();
            if (result.success) {
                if (result.firstTime) {
                    showRandomMessage(companionMessages);
                }
                await updateTable();
            } else {
                alert('猫咪今天已经得到了你的陪伴，它很开心哦！😻💖');
            }
        }

        async function toggleMiss(catId) {
            const response = await fetch(`${API_URL}/miss/${catId}`, { method: 'POST' });
            const result = await response.json();
            if (result.success) {
                if (result.firstTime) {
                    showRandomMessage(missMessages);
                }
                await updateTable();
            } else {
                alert(result.message);
            }
        }

        async function getHistoricalAttentionCounts() {
            try {
                const response = await fetch(`${API_URL}/historical-attention-counts`);
                const data = await response.text();
                const counts = {};
                data.split('\n').forEach(line => {
                    const [catId, count] = line.split(' | ');
                    counts[catId] = count;
                });
                return counts;
            } catch (error) {
                console.error('Error fetching historical attention counts:', error);
                return {};
            }
        }

        // 初始化表格获取用户IP
        updateTable();
        getUserIp();
    </script>
</body>